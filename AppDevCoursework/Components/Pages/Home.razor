@page "/"
@using AppDevCoursework.Data
@using Markdig
@inject DatabaseService DbService

<div class="container mt-4">
    <!-- Title and Date Selection -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1>My Daily Journal</h1>
        </div>
        <div class="col-12 d-flex justify-content-center">
             <div class="input-group" style="max-width: 300px;">
                <span class="input-group-text">Date:</span>
                <input type="date" class="form-control" 
                       @bind="CurrentDate" 
                       @bind:after="LoadEntryAsync" />
            </div>
        </div>
    </div>

    @if (IsLoading)
    {
        <div class="text-center">
            <p>Loading entry...</p>
        </div>
    }
    else
    {
        <!-- Main Form Container -->
        <div class="row">
            <div class="col-md-12">
                
                <!-- Mood Section -->
                <div class="card">
                    <div class="card-header">1. Mood Tracker</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Primary Mood:</label>
                                <select class="form-select" @bind="CurrentEntry.PrimaryMood">
                                    <option value="">Select Mood</option>
                                    @foreach (var mood in AllMoods)
                                    {
                                        <option value="@mood">@mood</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label>Secondary Moods (Optional, Max 2):</label>
                                <div>
                                    @foreach (var mood in AllMoods)
                                    {
                                        var isSelected = SelectedSecondaryMoods.Contains(mood);
                                        <button class="btn btn-sm m-1 @(isSelected ? "btn-primary" : "btn-outline-secondary")"
                                                @onclick="() => ToggleSecondaryMood(mood)">
                                            @mood
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tag Section -->
                <div class="card">
                    <div class="card-header">2. Tags</div>
                    <div class="card-body">
                        <div class="input-group mb-2">
                             <input type="text" class="form-control" placeholder="New tag name" 
                                    @bind="NewTag" @onkeyup="HandleTagEnter" />
                             <button class="btn btn-secondary" @onclick="AddTag">Add Tag</button>
                        </div>
                        
                        <div class="mb-2">
                            <strong>Current Tags: </strong>
                            @if (CurrentTags.Count == 0)
                            {
                                <span>None</span>
                            }
                            @foreach (var tag in CurrentTags)
                            {
                                <span class="badge bg-secondary me-1">
                                    @tag <span style="cursor:pointer; margin-left:5px;" @onclick="() => RemoveTag(tag)">x</span>
                                </span>
                            }
                        </div>

                        <div class="mt-2">
                            <small class="text-muted">Click to add suggestions: </small>
                            @foreach (var tag in SuggestedTags.Take(8))
                            {
                                if (!CurrentTags.Contains(tag.Name))
                                {
                                    <a href="javascript:void(0)" class="me-2" @onclick="() => AddSuggestedTag(tag.Name)">@tag.Name</a>
                                }
                            }
                        </div>
                    </div>
                </div>

                <!-- Journal Entry Section -->
                <div class="card">
                    <div class="card-header">3. Journal Entry</div>
                    <div class="card-body">
                         <!-- Simple Tabs for Write/Preview -->
                        <ul class="nav nav-tabs mb-3">
                          <li class="nav-item">
                            <a class="nav-link @(!IsPreviewMode ? "active" : "")" href="javascript:void(0)" @onclick="() => IsPreviewMode = false">Write (Markdown)</a>
                          </li>
                          <li class="nav-item">
                            <a class="nav-link @(IsPreviewMode ? "active" : "")" href="javascript:void(0)" @onclick="() => IsPreviewMode = true">Preview</a>
                          </li>
                        </ul>

                        @if (!IsPreviewMode)
                        {
                            <textarea class="form-control" rows="10" 
                                      @bind="CurrentEntry.Content"></textarea>
                            <small class="text-muted">Supported: *Italic*, **Bold**, - List</small>
                        }
                        else
                        {
                            <div class="border p-3" style="min-height: 200px; background-color: #fafafa;">
                                @((MarkupString)Markdown.ToHtml(CurrentEntry.Content ?? ""))
                            </div>
                        }
                    </div>
                </div>

                <!-- Actions -->
                <div class="d-grid gap-2 mb-5">
                    <button class="btn btn-primary btn-lg" @onclick="SaveEntryAsync">Save Daily Entry</button>
                    
                    @if (CurrentEntry.Id != 0)
                    {
                        <button class="btn btn-danger" @onclick="DeleteEntryAsync">Delete Entry</button>
                    }
                    
                    <p class="text-center text-success">@StatusMessage</p>
                </div>

            </div>
        </div>
    }
</div>

@inject IJSRuntime JSRuntime

@code {
    private DateTime CurrentDate = DateTime.Today;
    private JournalEntry CurrentEntry = new();
    private bool IsLoading = true;
    private string StatusMessage = "";
    private bool IsPreviewMode = false;

    // Moods
    private List<string> AllMoods = new() {
            "Calm", "Angry", "Grateful", "Curious", "Lonely",
            "Happy", "Nostalgic", "Stressed", "Confident", "Bored",
            "Relaxed", "Anxious", "Thoughtful", "Sad", "Excited"
        };

    private HashSet<string> SelectedSecondaryMoods = new();

    // Tags
    private string NewTag = "";
    private List<string> CurrentTags = new();
    private List<Tag> SuggestedTags = new();

    protected override async Task OnInitializedAsync()
    {
        SuggestedTags = await DbService.GetTagsAsync();
        await LoadEntryAsync();
    }

    private async Task LoadEntryAsync()
    {
        IsLoading = true;
        StatusMessage = "";
        CurrentEntry = await DbService.GetEntryByDateAsync(CurrentDate);

        if (CurrentEntry == null)
        {
            CurrentEntry = new JournalEntry 
            { 
                EntryDate = CurrentDate 
            };
            SelectedSecondaryMoods.Clear();
            CurrentTags.Clear();
        }
        else
        {
            SelectedSecondaryMoods = string.IsNullOrEmpty(CurrentEntry.SecondaryMoods)
                ? new HashSet<string>()
                : new HashSet<string>(CurrentEntry.SecondaryMoods.Split(',', StringSplitOptions.RemoveEmptyEntries));
            
            CurrentTags = string.IsNullOrEmpty(CurrentEntry.Tags)
                ? new List<string>()
                : CurrentEntry.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries).ToList();
        }

        IsLoading = false;
    }

    private void ToggleSecondaryMood(string mood)
    {
        if (SelectedSecondaryMoods.Contains(mood))
        {
            SelectedSecondaryMoods.Remove(mood);
        }
        else
        {
            if (SelectedSecondaryMoods.Count < 2)
            {
                SelectedSecondaryMoods.Add(mood);
            }
        }
    }

    private void HandleTagEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") AddTag();
    }

    private void AddTag()
    {
        if (!string.IsNullOrWhiteSpace(NewTag) && !CurrentTags.Contains(NewTag.Trim()))
        {
            CurrentTags.Add(NewTag.Trim());
            NewTag = "";
        }
    }

    private void AddSuggestedTag(string tag)
    {
        if (!CurrentTags.Contains(tag))
        {
            CurrentTags.Add(tag);
        }
    }

    private void RemoveTag(string tag)
    {
        CurrentTags.Remove(tag);
    }

    private async Task SaveEntryAsync()
    {
        CurrentEntry.SecondaryMoods = string.Join(",", SelectedSecondaryMoods);
        CurrentEntry.Tags = string.Join(",", CurrentTags);

        await DbService.SaveEntryAsync(CurrentEntry);
        StatusMessage = "Entry Saved Successfully!";
        
        foreach(var t in CurrentTags)
        {
            if (!SuggestedTags.Any(st => st.Name.Equals(t, StringComparison.OrdinalIgnoreCase)))
            {
                 var newTag = new Tag { Name = t };
                 await DbService.SaveTagAsync(newTag);
                 SuggestedTags.Add(newTag);
            }
        }
    }

    private async Task DeleteEntryAsync()
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this entry?");
        if (confirmed)
        {
            await DbService.DeleteEntryAsync(CurrentEntry);
            await LoadEntryAsync(); // Reloads (will be empty)
            StatusMessage = "Entry Deleted.";
        }
    }
}
